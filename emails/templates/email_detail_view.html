{% extends 'global/base.html' %}
{% load humanize %}
{% block basetitle %}
<title>{{ email.internal_title }} ({{ email.subject }})</title>
{% endblock %}
{% block content %}
<div class="container">
  <div class="card-header">
    <h2> {{ email.internal_title }} </h2>
    <div class="col text-right h2">
      <a class="button" href="{% url 'emails:render' h.pk email.pk %}">
        <button class="btn btn-primary ml-auto">Render</button>
      </a>
      <a class="button" href="{% url 'emails:edit' h.pk email.pk %}">
        <button class="btn btn-primary ml-auto">Edit</button>
      </a>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h2 class="col card-title">Status: &nbsp;
        {% if email.status == "draft" %}
        <span class="status-icon bg-gray-dark"></span> Draft
        {% elif email.status == 'scheduled' %}
        <span class="status-icon bg-pink"></span> Scheduled
        {% elif email.status == 'sent' %}
        <span class="status-icon bg-green"></span> Sent
        {% endif %}
      </h2>

      {% if uses_context %}
        <div class="col-sm-8 text-center" style="font-size: 14px">
          <i class="fe fe-alert-triangle" style="color: red"></i>
          <b style="font-size: 16px; color: red">This email uses per-recipient custom fields in its body.</b><br />
          Press "Render Email" on a contact below to see an example email.
        </div>
      {% endif %}
    </div>
  </div>

  <div class="row row-cards">
    <div class="col-sm-4">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Email Information</h2>
        </div>
        <div class="card-body">
          <p class="required-field">
            <label><b>Email Compose Template:</b></label>
            {{ email.email_type }}
          </p>
          {% if email.to_industries %}
          <p class="required-field">
            <label><b>Selected Industries: </b></label>
            {% for industry in email.to_industries.all %}
            <span class="tag tag-{{industry.color}}">{{ industry.name }}</span>
            {% endfor %}
          </p>
          <p class="required-field">
            <label><b>Company Sizes: </b></label>
            {% for size in email.size_selection %}
            {% if size == 'S' %}
            <span class="tag tag-blue">{{ size }}</span>
            {% elif size == 'M' %}
            <span class="tag tag-orange">{{ size }}</span>
            {% elif size == 'L' %}
            <span class="tag tag-pink">{{ size }}</span>
            {% endif %}
            {% endfor %}
          </p>
          {% endif %}
          {% if email.contacted_selection %}
          <p class="required-field">
            <label><b>Contacts who are: </b></label>
            {% for contacted in email.contacted_selection %}
            
            <span class="tag tag-red">{{ contacted }}</span>
            {% endfor %}
          </p>
          {% endif %}
          <p class="text-right">
            Last Updated: {{ email.last_update }}
          </p>
        </div>
      </div>
    </div>
    <div class="col-sm-8">
      <div class="card flex-grow-1">
        <div class="card-header">
          <h2 class="card-title"><b>Subject:</b> {{ email.subject }}</h2>
        </div>
        <div class="card-body">
          {{ email.body | safe }}
        </div>
      </div>
    </div>
  </div>

  {% if email.to_companies.all or not email.to_contacts.all %}
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">Email Filter</h2>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table card-table table-vcenter text-nowrap">
        {% if email.to_companies.all %}
          <tr>
            <th style="width: 150px">
              Companies:
            </th>
            <td>
              {% for c in email.to_companies.all %}
                <a href="{% url 'hackathons:sponsorships:view' h.pk c.pk %}">
                  {{ c }}</a>{% if not forloop.last %}, {% endif %}
              {% endfor %}
            </td>
          </tr>
        {% elif email.to_industries.all %}
          <tr>
            <th style="width: 150px">
              Industries:
            </th>
            <td>
              {% for i in email.to_industries.all %}
                <a href="{% url 'hackathons:sponsorships:show' h.pk %}?q={{ i }}">
                  {{ i }}</a>{% if not forloop.last %}, {% endif %}
              {% endfor %}
            </td>
          </tr>
          <tr>
            <th>
              With Size:
            </th>
            <td>
              {% for s in email.size_selection %}
                {{ s }}{% if not forloop.last %}, {% endif %}
              {% endfor %}
            </td>
          </tr>
        {% endif %}
          <tr>
            <th>
              With Primary:
            </th>
            <td>
              {% for p in email.primary_selection %}
                {% if p == 'P' %}Primary{% elif p == 'NP' %}Not Primary{% endif %}{% if not forloop.last %}, {% endif %}
              {% empty %}
                Any
              {% endfor %}
            </td>
          </tr>
          <tr>
            <th>
              With Times Contacted:
            </th>
            <td>
              {% for c in email.contacted_selection %}
                {% if c == 'U' %}
                Uncontacted{% elif c == 'C1' %}
                Contacted 1x{% elif c == 'C2' %}
                Contacted 2x{% elif c == 'C3' %}
                Contacted 3x or more{% endif %}{% if not forloop.last %}, {% endif %}
              {% empty %}
                Any
              {% endfor %}
            </td>
          </tr>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  {% if not email.to_companies.count and not email.to_contacts.count %}
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">Matched Companies</h2>
    </div>
    <div class="card-body">
      <div class="table-responsive">
          <table class="table card-table table-vcenter text-nowrap">
              <thead>
                  <tr>
                      <th>Company</th>
                      <th>Industries</th>
                      <th>Size</th>
                      <th>Tier</th>
                      <th>Contribution</th>
                      <th>Status</th>
                      <th></th>
                  </tr>
              </thead>
              <tbody>
                  {% for c in companies %}
                  <tr>
                      <td><a href="{% url 'hackathons:sponsorships:view' h.pk c.company.pk %}" class="text-inherit">
                          <b>{{ c.company }}</b>
                      </a></td>
                      <td>
                      {% for i in c.company.industries.all %}
                          <span class="tag tag-{{ i.color }}">{{ i.name }}</span>
                      {% endfor %}
                      </td>
                      <td>
                      {% if c.company.size == 'S' %}
                          <span class="tag tag-green">S</span>
                      {% endif %}
                      {% if c.company.size == 'M' %}
                          <span class="tag tag-yellow">M</span>
                      {% endif %}
                      {% if c.company.size == 'L' %}
                          <span class="tag tag-red">L</span>
                      {% endif %}
                      </td>
                      <td>
                        {% if c.sponsorship %}
                          {{ c.sponsorship.tier }}
                        {% else %}
                          None
                        {% endif %}
                      </td>
                      <td>
                        {% if c.sponsorship %}
                          ${{ c.sponsorship.contribution|intcomma }}
                        {% else %}
                          None
                        {% endif %}
                      </td>
                      <td>
                          {% with sponsorship=c.sponsorship %}
                              {% include "cards/sponsorship_status.html" %}
                          {% endwith %}
                      </td>
                      <td>
                          <a class="tag tag-green float-right" href="{% url 'hackathons:sponsorships:view' h.pk c.company.pk %}">
                              View Company
                          </a>
                      </td>
                  </tr>
                  {% empty %}
                  <tr><td colspan=6>
                  No companies.
                  </td></tr>
                  {% endfor %}
              </tbody>
          </table>
      </div>
    </div>
  </div>
  {% endif %}
  
  <div class="card">
      <div class="card-header">
          <h2 class="card-title">{% if email.to_contacts.count %}Selected Contacts{% else %}Matched Contacts{% endif %}</h2>
      </div>
      <div class="card-body">
        {% if uses_context %}
          {% with show_company_name=1 view_action_button=1 email_render_pk=email.pk %}
            {% include "cards/lead_contacts_combined_table.html" %}
          {% endwith %}
        {% else %}
          {% with show_company_name=1 view_action_button=1 %}
            {% include "cards/lead_contacts_combined_table.html" %}
          {% endwith %}
        {% endif %}
      </div>
  </div>

</div>
{% endblock %}